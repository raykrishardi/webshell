<!doctype html>
  <html>
    <head>
      <link rel="stylesheet" href="./node_modules/xterm/css/xterm.css" />
      <script src="./node_modules/xterm/lib/xterm.js"></script>
      <script src="./node_modules/xterm-addon-fit/lib/xterm-addon-fit.js"></script>
  <style>
    div#terminal {
      position: fixed;
      width: 100%;
      height: 100%;
      left: 0;
      top: 0;
      background: #181818;
      z-index: 10;
    }
  </style>
    </head>
    <body>
      <div id="terminal"></div>
      <script>
        var terminal = new Terminal({
          screenKeys: true,
          useStyle: true,
          cursorBlink: true,
          fullscreenWin: true,
          maximizeWin: true,
          screenReaderMode: true,
          cols: 128,
          scrollback: 9999999,
        });
        terminal.open(document.getElementById('terminal'));


        // Init and load addon
        var fitAddon = new FitAddon.FitAddon();
        terminal.loadAddon(fitAddon);

        function prompt(terminal) {
         command = '';
         terminal.write('\r\n$ ');
        }

        var frontEndCommand = {
          "clear": {
            f: () => {
              terminal.write('\x1bc')
              prompt(terminal)
            }
          }
        }
        var command = "";



        prompt(terminal)
        fitAddon.fit();

        var url = "ws://127.0.0.1:8080/ws"
        var ws = new WebSocket(url);

        ws.onclose = function(event) {
          console.log(event);
          terminal.write('\r\nconnection has been terminated from the server-side (hit refresh to restart)\r\n')
          prompt(terminal)
        };

        ws.onopen = function() {
          terminal._initialized = true;
          terminal.focus();
          setTimeout(function() {fitAddon.fit()});
          {{/* terminal.onResize(function(event) {
            var rows = event.rows;
            var cols = event.cols;
            console.log(rows)
            console.log(cols)
            var size = JSON.stringify({cols: cols, rows: rows + 1});
            console.log(size)
            var send = new TextEncoder().encode("\x01" + size);
            console.log('resizing to', size);
            ws.send(send);
          });
          terminal.onTitleChange(function(event) {
            console.log(event);
          });
          window.onresize = function() {
            fitAddon.fit();
          }; */}}
        };

        ws.onmessage = (event) => {
          if (event.data !== "") {
            terminal.write("\r\n" + event.data)
            prompt(terminal)
          }
        }

        terminal.onData(e => {
         switch (e) {
           case '\u0003': // Ctrl+C
             terminal.write('^C');
             prompt(terminal);
             break;
           case '\r': // Enter
             if (command === '') {
              prompt(terminal);
             } else if (command in frontEndCommand) {
              frontEndCommand[command].f()
             } else {
              ws.send(command); // Send command to server and reset command var
             }
             break;
           case '\u007F': // Backspace (DEL)
             // Do not delete the prompt
             if (terminal._core.buffer.x > 2) {
               terminal.write('\b \b');
               if (command.length > 0) {
                 command = command.substr(0, command.length - 1);
               }
             }
             break;
           default: // Print all other characters
             if (e >= String.fromCharCode(0x20) && e <= String.fromCharCode(0x7E) || e >= '\u00a0') {
               command += e;
               terminal.write(e);
             }
         }

         console.log(command)
        });

      </script>
    </body>
  </html>